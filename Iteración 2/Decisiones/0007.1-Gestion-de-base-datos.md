# Estrategia global de bases de datos para la arquitectura de microservicios
* Status: Accepted
* Date: 18/02/2025
* Decision-Makers: Alejandro Rico, Daniel Rong
* Consulted: Elena Ceinos, Gaizka Aranbarri
* Informed: Jon Mazcuñán, Alberto Acebes, Pablo Villamayor
---

## Context and Problem Statement

La empresa de productos alimenticios está migrando de un sistema monolítico a una arquitectura de microservicios. El sistema actual cuenta con dos bases de datos SQL: una BBDD de Clientes (que contiene datos de clientes y pagos) y una BBDD de Pedidos (que almacena los datos restantes). Es necesario decidir cómo estructurar estas bases de datos para soportar la nueva arquitectura, considerando aspectos como el desacoplamiento, la escalabilidad y la integridad de los datos.

---

## Drivers de Decisión

* RD-02: Utilización de una base de datos
* RD-04: La arquitectura deberá contar necesariamente con microservicios
* RD-05: Arquitectura basada en microservicios
* RF-02: Acceder a la base de datos
* RF-10: Gestión de componentes críticos

---

## Considered Options

### 0007.1-1: Mantener dos bases de datos monolíticas sin cambios estructurales
* **Good** porque minimiza los cambios en la estructura de datos existente.
* **Good** porque simplifica la migración inicial al mantener la estructura de datos conocida.
* **Bad** porque mantiene el acoplamiento entre los diferentes dominios de negocio.
* **Bad** porque limita la escalabilidad independiente de los microservicios.
* **Bad** porque contradice los principios fundamentales de una arquitectura de microservicios.

### 0007.1-2: Migrar a una única base de datos compartida entre todos los microservicios
* **Good** porque centraliza todos los datos, facilitando consultas complejas entre dominios.
* **Good** porque simplifica la gestión de transacciones que involucran múltiples entidades.
* **Bad** porque introduce un acoplamiento fuerte entre los microservicios.
* **Bad** porque genera un único punto de fallo para toda la aplicación.
* **Bad** porque limita la capacidad de los equipos para evolucionar sus modelos de datos.

### 0007.1-3: Mantener dos bases de datos con segregación lógica por dominio
* **Good** porque mantiene la estructura general de dos bases de datos del sistema actual.
* **Good** porque permite una migración más gradual al no cambiar el número de sistemas de base de datos.
* **Good** porque separa los dominios de datos según su naturaleza.
* **Good** porque alinea la arquitectura de datos con la estructura organizativa y de dominio del negocio.
* **Bad** porque sigue manteniendo cierto nivel de acoplamiento entre servicios del mismo dominio.
* **Bad** porque limita parcialmente la escalabilidad independiente de cada microservicio.
* **Bad** porque puede complicar las transacciones que atraviesan ambos dominios.

---

## Decision Outcome

**Chosen option: "0007.1-3: Mantener dos bases de datos con segregación lógica por dominio"**

Se mantendrán las dos bases de datos existentes, pero reorganizando su estructura interna para alinearla con los dominios de microservicios. La primera base de datos (anteriormente "Clientes") se dedicará a los microservicios relacionados con usuarios, autenticación y pagos. La segunda base de datos (anteriormente "Pedidos") contendrá los datos para los microservicios de pedidos, reparto, estadísticas y noticias.

Cada microservicio tendrá acceso exclusivo a su propio esquema o conjunto de tablas dentro de la base de datos correspondiente a su dominio, implementando el patrón Repository para garantizar el aislamiento lógico entre servicios que comparten la misma base de datos física.


---

## Positive Consequences

* Se mantiene la estructura familiar de dos bases de datos, facilitando la migración.
* La segregación lógica mejora el desacoplamiento entre microservicios.
* Se facilita la gestión de transacciones dentro del mismo dominio.
* Se reduce la complejidad operativa al mantener solo dos sistemas de base de datos.
* El uso del patrón Repository proporciona una capa de abstracción que permite cambiar la implementación de la base de datos sin afectar la lógica de negocio.

---

## Negative Consequences

* No se alcanza el máximo nivel de desacoplamiento que ofrecería una base de datos por microservicio.
* Se mantiene cierta posibilidad de interferencia entre microservicios que comparten la misma base de datos.
* Se requiere una gestión cuidadosa de permisos y accesos para garantizar el aislamiento adecuado.
* Las operaciones de mantenimiento en una base de datos podrían afectar a múltiples microservicios.

---

## Clases que se añaden

- `Repository<T>`: Interfaz genérica que define operaciones básicas de persistencia.
  - **Necesaria porque** proporciona un contrato estándar para el acceso a datos en todos los microservicios.

- `EntitySpecification<T>`: Clase para definir criterios de búsqueda complejos.
  - **Necesaria porque** encapsula condiciones de filtrado sin acoplar la lógica de negocio a tecnologías específicas.

- `SchemaManager`: Componente para gestionar la segregación lógica de esquemas en cada base de datos.
  - **Necesaria porque** garantiza el aislamiento entre los datos de diferentes microservicios.

- `DatabaseConfig`: Clase de configuración para la conexión a la base de datos en cada microservicio.
  - **Necesaria porque** permite externalizar y gestionar la configuración específica de cada base de datos.

- `UnitOfWork`: Interfaz para gestionar transacciones y asegurar la consistencia.
  - **Necesaria porque** proporciona un contexto transaccional para operaciones que modifican múltiples entidades.

---