# Arquitectura acceso a bases de datos
* Status: Accepted
* Date: 18/02/2025
* Decision-Makers: Alejandro Rico, Daniel Rong
* Consulted: Elena Ceinos, Gaizka Aranbarri
* Informed: Jon Mazcuñán, Alberto Acebes, Pablo Villamayor
---

## Context and Problem Statement

Habiendo decidido mantener dos bases de datos físicas con segregación lógica por dominio (ADR 0007.1), necesitamos definir la arquitectura de acceso a datos desde los microservicios. Esto implica establecer patrones que respeten los límites lógicos entre microservicios aunque compartan la misma base de datos física, manteniendo los principios de encapsulamiento y cohesión propios de una arquitectura de microservicios.

---

## Drivers de Decisión

* RF-02: Acceder a la base de datos
* RF-02.1: Acceder a los datos personales de los clientes
* RD-02: Utilización de una base de datos
* RD-05: La arquitectura deberá contar necesariamente con microservicios

---

## Considered Options

### 0007.2-1: Acceso directo a bases de datos desde cada microservicio
* **Good** porque simplifica la implementación inicial al no requerir capas adicionales.
* **Good** porque reduce la latencia al eliminar intermediarios en el acceso a datos.
* **Bad** porque expone detalles de implementación de la base de datos a la lógica de negocio.
* **Bad** porque no garantiza el aislamiento entre microservicios que comparten la misma base de datos.
* **Bad** porque dificulta los cambios en el esquema o tecnología de base de datos.

### 0007.2-2: Implementación estricta del patrón Repository con aislamiento por esquema
* **Good** porque encapsula la lógica de acceso a datos, ocultando detalles de implementación.
* **Good** porque garantiza el aislamiento entre microservicios aunque compartan la misma base de datos.
* **Good** porque facilita los cambios en el esquema o tecnología de base de datos.
* **Good** porque mejora la testeabilidad al permitir repositorios mock para pruebas.
* **Bad** porque añade una capa adicional de complejidad al código.
* **Bad** porque puede limitar el acceso a características avanzadas específicas de la base de datos.

### 0007.2-3: Servicios compartidos de acceso a datos por dominio
* **Good** porque centraliza la lógica de acceso a datos para microservicios del mismo dominio.
* **Good** porque reduce la duplicación de código de acceso a datos.
* **Bad** porque crea un acoplamiento entre servicios que contradice los principios de microservicios.
* **Bad** porque introduce puntos de fallo compartidos entre microservicios.
* **Bad** porque dificulta la evolución independiente de cada microservicio.

---

## Decision Outcome

**Chosen option: "0007.2-2: Implementación estricta del patrón Repository con aislamiento por esquema"**

Cada microservicio implementará el patrón Repository para acceder exclusivamente a su propio esquema o conjunto de tablas dentro de la base de datos correspondiente. Estos repositorios encapsularán toda la lógica de acceso a datos y proporcionarán una interfaz orientada al dominio que oculte los detalles de implementación de la base de datos.

Para reforzar el aislamiento, cada microservicio tendrá credenciales de acceso restringidas únicamente a su propio esquema, aunque físicamente comparta la base de datos con otros microservicios. La capa de Repository actuará como barrera de abstracción, asegurando que los cambios en la estructura de la base de datos no afecten a la lógica de negocio.

---

## Positive Consequences

* Fuerte desacoplamiento lógico entre microservicios aunque compartan base de datos física.
* Facilidad para realizar pruebas unitarias mediante mocks de los repositorios.
* Capacidad para evolucionar independientemente el esquema de datos de cada microservicio.
* Posibilidad de migrar en el futuro a bases de datos físicamente separadas sin afectar la lógica de negocio.
* Mejora en la seguridad al limitar el acceso de cada microservicio solo a sus propios datos.

---

## Negative Consequences

* Aumento en la cantidad inicial de código a desarrollar.
* Posible duplicación de código entre repositorios de diferentes microservicios.
* Mayor complejidad para consultas que requieren datos de múltiples dominios.
* Posible sobrecarga de rendimiento por la capa adicional de abstracción.

---

## Clases que se añaden

- Interfaces de repositorio específicas para cada entidad de dominio:
  - `ClienteRepository`: Para acceso a datos de clientes.
  - `PedidoRepository`: Para acceso a datos de pedidos.
  - `RutaRepository`: Para acceso a datos de rutas y repartos.
  - `PagoRepository`: Para acceso a datos de pagos.

- Implementaciones concretas de los repositorios:
  - `SqlClienteRepository`: Implementación SQL para la BBDD de Clientes.
  - `SqlPedidoRepository`: Implementación SQL para la BBDD de Pedidos.

- Componentes de soporte:
  - `ConnectionManager`: Gestiona las conexiones a las bases de datos.
  - `QueryBuilder`: Facilita la construcción de consultas SQL.
  - `TransactionManager`: Gestiona las transacciones dentro de cada base de datos.

---